# Implementation Documentation: Backend Integration Wrapper

The `BackendAPI` class is a high-level wrapper built on the `requests` library. Its primary purpose is to synchronize the state between the persistent database (FastAPI) and the volatile AI inference environment.

---

## Overview

The integration layer acts as a data translator. It handles HTTP communication, status code verification, and—most importantly—**schema mapping**. It converts backend-specific models into the "Orchestrator Format" used by the agents.



---

## Core Functionalities

### 1. User Subject Extraction (`get_user_data`)
Fetches all academic tasks associated with a specific user.

* **Endpoint**: `/users/{user_id}/subjects`
* **Transformation Logic**: Maps the `SubjectResponse` from the backend into the "Task" dictionary required by `CSAgent` and `MathAgent`.
* **Key Mapping**:
    * `start_date` → `start_datetime`
    * `name` → `subject_name/project_name`
    * `type` → Identifies the heuristic set to apply (Exam vs. Project).

### 2. Iterative Feedback Fetching (`get_current_and_last_feedback`)
Retrieves the historical record of user performance to support the `FeedbackAgent`.

* **Endpoint**: `/users/{user_id}/feedback/latest`
* **Logic**: Returns the two most recent feedback entries.
    * **Latest Entry**: Becomes `current_feedback`.
    * **Previous Entry**: Becomes `last_feedback`.
* **Graceful Failure**: If no feedback exists, it returns an empty dictionary instead of raising an exception, allowing the AI to generate a plan without prior context.

### 3. Schedule Synchronization (`get_latest_schedule`)
Provides the baseline calendar for rescheduling or modification.

* **Endpoint**: `/users/{user_id}/plans/latest-schedule`
* **Reconstruction**: Rebuilds the "Day Entry" objects. It nests individual AI tasks (entries) inside their respective dates, recreating the structured JSON format that the `FeedbackAgent` expects to "refine."

---

## Schema Mapping Table

The following table shows how data is translated from the Backend (DB) to the Orchestrator (AI):

| Backend Field | AI Orchestrator Field | Description |
| :--- | :--- | :--- |
| `s["title"]` | `title` | The specific goal of the task. |
| `s["name"]` | `subject_name/project_name` | The parent subject (e.g., Calculus). |
| `fb["comments"]` | `text` | The raw text feedback from the user. |
| `task["ai_task_name"]` | `task_name` | The specific sub-task generated by AI. |

---

## Error Handling & Robustness

The `BackendAPI` implementation follows a "Fail-Safe" philosophy for non-critical data:

1.  **Strict Enforcement**: For `get_user_data`, the system raises an `Exception` if the status code is not 200. This is because the AI cannot function without the base task data.
2.  **Soft Failure**: For `feedback` and `schedules`, the system uses `try...except` blocks with print warnings. If these calls fail, the functions return `{} ` or `None`.
    * *Why?* It is better for the AI to generate a "fresh" plan than to crash the entire system because historical feedback is missing.

---

## Connection Configuration

The class is initialized with a `base_url`, ensuring that the environment (Development vs. Production) can be swapped easily.

```python
# Initialization Example
api = BackendAPI(base_url="[https://api.university-planner.com](https://api.university-planner.com)")
user_tasks = api.get_user_data(user_id=101)